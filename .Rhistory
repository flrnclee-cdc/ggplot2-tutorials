type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
# save!
saveWorkbook(wb, output_file, overwrite = TRUE)
}
# Initial set up ---------------------------------------------------------------
library(pdftools)
library(stringr)
library(dplyr)
library(tidyr)
library(openxlsx)
library(readtext)
library(officer)
library(readxl)
library(openxlsx)
# specify batch
batch_num <- "Batch_17"
# specify date of run
today_date <- Sys.Date()
# specify batch folder with files
batch_to_use <- "Batch 17_01.16.2026"
# path with files
folder_path <- paste0("C:/Users/kwn5/OneDrive - CDC/MESP-DGHT Program Planning - 03_Compliance Specialists/03_Final screen by date/", batch_to_use)
# path to terms
term_path <- "C:/Users/kwn5/OneDrive - CDC/Sexton, Connie (CDC_GHC_DGHT)'s files - pre-NOFO Screening Tool_OD Files/Review terminology_Nov 10.xlsx"
# path to save results
results_path <- paste0("C:/Users/kwn5/OneDrive - CDC/MESP-DGHT Program Planning - 03_Compliance Specialists/03_Final screen by date/Pre-NOFO Final Screen Output Files")
message("Reading files from: ", folder_path)
message("Export results to: ", results_path)
# CONVERT DOC TO PDF ===========================================================
#' Comment out if no Word docs need to be converted to PDF
#' Recommend running this conversion and then commenting out code that runs analysis on docs
source("C:/Users/kwn5/OneDrive - CDC/Sexton, Connie (CDC_GHC_DGHT)'s files - Test Folder/convert_doc_to_pdf.R")
# CREATE LIST OF TERMS  ========================================================
# Adobe process ----------------------------------------------------------------
term_list <- read.xlsx(term_path, sheet="Terms") %>%
select("Terminology", "EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words") %>%
filter(!(Terminology %in% c("", " "))) %>%
mutate(Terminology = tolower(str_trim(Terminology)))
term_list_check <- term_list %>%
group_by(Terminology) %>%
count() %>%
filter(n>1) %>%
arrange(-n)
message("Terms to check: ", nrow(term_list_check))
# term_list <- term_list %>%
#   group_by(Terminology) %>%
#   slice_head(n = 1) %>%
#   ungroup() %>% as.data.frame()
term_col <- term_list[,1]
terms <- paste(term_col, collapse = " OR ")
writeLines(terms, paste0(results_path, "/terms_to_use.txt"))
# R process --------------------------------------------------------------------
keywords <- term_col
# Combine keywords into regex: Case-insensitive
pattern <- paste0("(", paste(keywords, collapse = "|"), ")")
# Combine keywords into regex: Case-insensitive, exact word match
pattern_exact <- paste0("\\b(", paste(keywords, collapse = "|"), ")\\b")
# CREATE FUNCTIONS =============================================================
# Function to extract terms from PDF -------------------------------------------
extract_from_pdf <- function(files_to_examine, pattern_to_use) {
if (length(files_to_examine)==0) return ( NULL )
# Initialize empty list
pdf_results <- list()
# Loop through each PDF file
for (file in files_to_examine) {
message("Reading: ", file)
pages <- pdftools::pdf_text(file)
#pages_lower <- tolower(pages)
# Extract results for each page
page_results <- lapply(seq_along(pages), function(p) {
text <- pages[p]
text <- str_replace_all(text, "\\n", " ")
# Find keyword matches with regex (captures the keyword)
matches <- str_locate_all(text, regex(pattern_to_use, ignore_case = TRUE))[[1]]
if (nrow(matches) == 0) return(NULL)
# Create context snippet around each match
snippets <- apply(matches, 1, function(m) {
start <- max(1, m[1] - 100)
end <- min(nchar(text), m[2] + 100)
snippet <- substr(text, start, end)
snippet <- str_replace_all(snippet, "[\\r\\n]+", " ")  # remove newlines
snippet
})
# Identify which keyword matched
found_keywords <- str_extract_all(text, regex(pattern_to_use, ignore_case = TRUE))[[1]] %>% tolower()
# Build page-level dataframe
data.frame(
file_type = "PDF",
file_name = basename(file),
page_or_sheet = p,
row = NA,
keyword = found_keywords,
snippet = snippets,
stringsAsFactors = FALSE
)
})
# Combine all pages for this file
pdf_results[[file]] <- bind_rows(page_results)
}
# Combine across all PDFs
pdf_long <- bind_rows(pdf_results)
pdf_long$page_or_sheet <- as.character(pdf_long$page_or_sheet)
return(pdf_long)
}
# Function to extract terms from Word ------------------------------------------
extract_from_word <- function(files_to_examine, pattern_to_use) {
if (length(files_to_examine)==0) return ( NULL )
# Initialize empty list
doc_results <- list()
for (file in files_to_examine) {
message("Reading: ", file)
# Safely read text from each paragraph in the Word file
text <- tryCatch({
doc <- read_docx(file)
content <- docx_summary(doc)
text <- paste(content$text, collapse = " ")
}, error = function(e) {
warning(paste("Could not read file:", basename(file), "-", e$message))
return(NULL)
})
if (is.null(text) || nchar(text) == 0) next
# Find keyword matches
matches <- str_locate_all(text, regex(pattern_to_use, ignore_case = TRUE))[[1]]
if (nrow(matches) == 0) next
found_keywords <- str_extract_all(text, regex(pattern_to_use, ignore_case = TRUE))[[1]] %>% tolower()
snippets <- apply(matches, 1, function(m) {
start <- max(1, m[1] - 100)
end <- min(nchar(text), m[2] + 100)
snippet <- substr(text, start, end)
snippet <- str_replace_all(snippet, "[\\r\\n]+", " ")
snippet
})
df <- data.frame(
file_type = "Document",
file_name = basename(file),
page_or_sheet = NA,
row = NA,
keyword = found_keywords,
snippet = snippets,
stringsAsFactors = FALSE
)
doc_results[[file]] <- df
}
# Combine all document results
doc_hits <- bind_rows(doc_results)
doc_hits$page_or_sheet <- as.character(doc_hits$page_or_sheet)
return(doc_hits)
}
# Function to extract terms from Excels ----------------------------------------
#' This block reads in every excel document within the specified folder path
#' and flags the keywords, as well as the row (+/- 1 depending on how the rows
#' are organized in the spreadsheet), sheet, and workbook that they appear in
# Function to search keywords in a dataframe
search_keywords_in_df <- function(df, pattern) {
df_char <- data.frame(lapply(df, function(x) {
x <- as.character(x)
x[is.na(x)] <- ""
x
}), stringsAsFactors = FALSE)
combined_text <- apply(df_char, 1, function(row) paste(row, collapse = " "))
str_extract_all(combined_text, regex(pattern, ignore_case = TRUE))
}
extract_from_excel <- function(files_to_examine, pattern_to_use) {
if (length(files_to_examine)==0) return ( NULL )
all_results <- list()
for (file in files_to_examine) {
message("Reading: ", file)
# Add long path prefix for Windows
file_long <- paste0("\\\\?\\", normalizePath(file))
# Get sheet names safely
sheet_names <- tryCatch({
excel_sheets(file_long)
}, error = function(e) {
warning(paste("Could not read sheets for file:", basename(file), "-", e$message))
return(NULL)
})
if (is.null(sheet_names)) next
# Read each sheet safely
all_sheets <- lapply(sheet_names, function(sheet) {
tryCatch({
read_excel(file_long, sheet = sheet)
}, error = function(e) {
warning(paste("Could not read sheet:", sheet, "-", e$message))
return(NULL)
})
})
names(all_sheets) <- sheet_names
# Convert all text to lowercase
all_sheets_lower <- lapply(all_sheets, function(df) {
if (is.null(df)) return(NULL)
df_char <- data.frame(lapply(df, function(x) tolower(as.character(x))), stringsAsFactors = FALSE)
return(df_char)
})
# Search for keywords
results <- lapply(all_sheets_lower, function(df) {
if (is.null(df)) return(list())
search_keywords_in_df(df, pattern_to_use)
})
# Compile results per sheet, skipping rows with no matches
file_results <- bind_rows(
lapply(seq_along(results), function(i) {
sheet_name <- names(all_sheets_lower)[i]
found_list <- results[[i]]
if (length(found_list) == 0) return(NULL)
# Keep only rows with at least one match
non_empty <- which(sapply(found_list, length) > 0)
if (length(non_empty) == 0) return(NULL)
found_list <- found_list[non_empty]
data.frame(
file_type = "Excel",
file_name = basename(file),
page_or_sheet = sheet_name,
row = non_empty,
snippet = NA,
keyword = sapply(found_list, function(x) paste(unique(x), collapse = ", ")),
stringsAsFactors = FALSE
)
})
)
all_results[[file]] <- file_results
}
# Combine all files into one dataframe
results_df <- bind_rows(all_results)
# Final check: remove any accidental empty rows
results_df <- results_df %>%
filter(keyword != "" & !is.na(keyword)) %>%
mutate(row = row + 1)
results_df$page_or_sheet <- as.character(results_df$page_or_sheet)
return(results_df)
}
# RUN SEARCHES =================================================================
# List all files ---------------------------------------------------------------
pdf_files <- list.files(folder_path, pattern = "\\.pdf$", full.names = TRUE)
doc_files <- list.files(folder_path, pattern = "\\.docx$", full.names = TRUE)
xlsx_files <- list.files(folder_path, pattern = "\\.xlsx$", full.names = TRUE)
message("Number of PDFs: ", length(pdf_files))
message("Number of Docs: ", length(doc_files))
message("Number of Excels: ", length(xlsx_files))
# General search ---------------------------------------------------------------
pdf_hits <- extract_from_pdf(pdf_files, pattern)
doc_hits <- NULL
# doc_hits <- extract_from_word(doc_files, pattern)
excel_hits <- extract_from_excel(xlsx_files, pattern)
# Exact search -----------------------------------------------------------------
pdf_hits_ex <- extract_from_pdf(pdf_files, pattern_exact)
doc_hits_ex <- NULL
# doc_hits_ex <- extract_from_word(doc_files, pattern_exact)
excel_hits_ex <- extract_from_excel(xlsx_files, pattern_exact)
# Separate into exact vs. other matches ----------------------------------------
if (!is.null(nrow(pdf_hits))) {
nrow(pdf_hits) >= nrow(pdf_hits_ex)
pdf_hits_ot <- anti_join(pdf_hits, pdf_hits_ex) %>% mutate(search_type="Other")
pdf_hits_ex <- pdf_hits_ex %>% mutate(search_type="Exact")
pdf_hits <- bind_rows(pdf_hits_ot, pdf_hits_ex) %>% arrange(search_type, file_name, page_or_sheet)
# add summary info
pdf_summ <- pdf_hits %>%
group_by(keyword, file_name, search_type) %>%
summarise(
pages = paste(unique(page_or_sheet), collapse = ", "),
total_occurrences = n(),
.groups = "drop"
) %>%
select(file_name, pages, keyword, total_occurrences, search_type) %>%
arrange(file_name, search_type, pages)
# merge in categories
pdf_hits <- pdf_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
pdf_summ <- pdf_summ %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
if (!is.null(nrow(doc_hits))) {
nrow(doc_hits) >= nrow(doc_hits_ex)
doc_hits_ot <- anti_join(doc_hits, doc_hits_ex) %>% mutate(search_type="Other")
doc_hits_ex <- doc_hits_ex %>% mutate(search_type="Exact")
doc_hits <- bind_rows(doc_hits_ot, doc_hits_ex) %>% arrange(search_type, file_name)
doc_summ <- doc_hits %>%
group_by(keyword, file_name, search_type) %>%
summarise(total_occurrences = n(), .groups = "drop") %>%
select(file_name, keyword, total_occurrences, search_type) %>%
arrange(file_name, search_type)
# merge in categories
doc_hits <- doc_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
doc_summ <- doc_summ %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
if (!is.null(nrow(excel_hits))) {
nrow(excel_hits) >= nrow(excel_hits_ex)
excel_hits_ot <- anti_join(excel_hits, excel_hits_ex)  %>% mutate(search_type="Other")
excel_hits_ex <- excel_hits_ex %>% mutate(search_type="Exact")
excel_hits <- bind_rows(excel_hits_ot, excel_hits_ex) %>% arrange(search_type, file_name, page_or_sheet, row)
# merge in categories
excel_hits <- excel_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
# Combine all files ------------------------------------------------------------
# all_hits <- bind_rows(pdf_hits, doc_hits, excel_hits)
all_hits <- bind_rows(pdf_hits, excel_hits) #no word file results
# OUTPUT AS EXCEL ==============================================================
# Workbook formatting ----------------------------------------------------------
eo.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#000000",
border = "Bottom", borderStyle = "thick")
sc.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#AF51A8",
border = "Bottom", borderStyle = "thick")
wv.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#B43636",
border = "Bottom", borderStyle = "thick")
st.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#3C7D22",
border = "Bottom", borderStyle = "thick")
fr.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#BE5014",
border = "Bottom", borderStyle = "thick")
kw.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#4D93D9",
border = "Bottom", borderStyle = "thick")
gn.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#002060",
border = "Bottom", borderStyle = "thick")
# For OD -----------------------------------------------------------------------
#' OD file will include results for ALL files as well as summary pages
# create output workbook
output_file <- file.path(results_path, paste0(batch_num, "_OD-results_", today_date, ".xlsx"))
wb <- createWorkbook()
addWorksheet(wb, "Matches | Snippets")
writeData(wb, "Matches | Snippets", all_hits, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | Snippets", cols = 1:ncol(all_hits), widths = "auto")
addWorksheet(wb, "Matches | PDF Summary")
writeData(wb, "Matches | PDF Summary", pdf_summ, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | PDF Summary", cols = 1:ncol(pdf_summ), widths = "auto")
if (!is.null(doc_hits)) {
addWorksheet(wb, "Matches | Doc Summary")
writeData(wb, "Matches | Doc Summary", doc_summ, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | Doc Summary", cols = 1:ncol(doc_summ), widths = "auto")
}
saveWorkbook(wb, output_file, overwrite = TRUE)
# For Reviewers ----------------------------------------------------------------
#' For reviewers, include only exact, all_hit results with a separate tab for
#' each theme, a dropdown for compliance action, and a box for comments
all_files <- all_hits$file_name %>% unique()
for (file in all_files) {
# create separate sheets for each theme
eo_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(EO)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words")) %>%
mutate(followup_action=NA, reviewer_notes=NA)
sci_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Science)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
wai_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Waiver_Bridge)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
strat_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Strategic.Content)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
frame_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Framing)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
key_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Key_Words)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
# create workbook
output_file <- file.path(results_path, paste0("Results_", file %>% str_replace_all("_Converted.pdf", ""), "_", today_date, ".xlsx"))
wb <- createWorkbook()
# add EO match sheet
addWorksheet(wb, "Matches | EO Compliance")
writeData(wb, "Matches | EO Compliance", eo_hits, headerStyle = eo.style)
setColWidths(wb, sheet = "Matches | EO Compliance", cols = 1:ncol(eo_hits), widths = "auto")
# add Science match sheet
addWorksheet(wb, "Matches | Science")
writeData(wb, "Matches | Science", sci_hits, headerStyle = sc.style)
setColWidths(wb, sheet = "Matches | Science", cols = 1:ncol(sci_hits), widths = "auto")
# add Waiver match sheet
addWorksheet(wb, "Matches | Waiver_Bridge")
writeData(wb, "Matches | Waiver_Bridge", wai_hits, headerStyle = wv.style)
setColWidths(wb, sheet = "Matches | Waiver_Bridge", cols = 1:ncol(wai_hits), widths = "auto")
# add Strategic Content match sheet
addWorksheet(wb, "Matches | Strategic Content")
writeData(wb, "Matches | Strategic Content", strat_hits, headerStyle = st.style)
setColWidths(wb, sheet = "Matches | Strategic Content", cols = 1:ncol(strat_hits), widths = "auto")
# add Framing match sheet
addWorksheet(wb, "Matches | Framing")
writeData(wb, "Matches | Framing", frame_hits, headerStyle = fr.style)
setColWidths(wb, sheet = "Matches | Framing", cols = 1:ncol(frame_hits), widths = "auto")
# add Keywords match sheet
addWorksheet(wb, "Matches | Keywords")
writeData(wb, "Matches | Keywords", key_hits, headerStyle = kw.style)
setColWidths(wb, sheet = "Matches | Keywords", cols = 1:ncol(key_hits), widths = "auto")
# set up dropdown values
action_options <- data.frame(
actions = c("Reviewed. No issue", "Reviewed. Potential issue. Further review needed."))
# add dropdown sheet
addWorksheet(wb, "DropdownValues")
writeData(wb, sheet = "DropdownValues", x = action_options, colNames = FALSE)
sheetVisibility(wb)[7] <- "hidden"
# add dropdown to the followup_action column
dataValidation(
wb,
sheet = "Matches | EO Compliance",
col = 8,
rows = 2:(nrow(eo_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Science",
col = 8,
rows = 2:(nrow(sci_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Waiver_Bridge",
col = 8,
rows = 2:(nrow(wai_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Strategic Content",
col = 8,
rows = 2:(nrow(strat_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Framing",
col = 8,
rows = 2:(nrow(frame_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Keywords",
col = 8,
rows = 2:(nrow(frame_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
# add conditional formatting to the followup_action column
conditionalFormatting(
wb,
sheet = "Matches | EO Compliance",
cols = 8,
rows = 2:(nrow(eo_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Science",
cols = 8,
rows = 2:(nrow(sci_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Waiver_Bridge",
cols = 8,
rows = 2:(nrow(wai_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Strategic Content",
cols = 8,
rows = 2:(nrow(strat_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Framing",
cols = 8,
rows = 2:(nrow(frame_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Keywords",
cols = 8,
rows = 2:(nrow(frame_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
# save!
saveWorkbook(wb, output_file, overwrite = TRUE)
}
