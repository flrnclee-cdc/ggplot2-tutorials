# Combine all files into one dataframe
results_df <- bind_rows(all_results)
# Final check: remove any accidental empty rows
results_df <- results_df %>%
filter(keyword != "" & !is.na(keyword)) %>%
mutate(row = row + 1)
results_df$page_or_sheet <- as.character(results_df$page_or_sheet)
return(results_df)
}
# RUN SEARCHES =================================================================
# List all files ---------------------------------------------------------------
pdf_files <- list.files(folder_path, pattern = "\\.pdf$", full.names = TRUE)
doc_files <- list.files(folder_path, pattern = "\\.docx$", full.names = TRUE)
xlsx_files <- list.files(folder_path, pattern = "\\.xlsx$", full.names = TRUE)
message("Number of PDFs: ", length(pdf_files))
message("Number of Docs: ", length(doc_files))
message("Number of Excels: ", length(xlsx_files))
# General search ---------------------------------------------------------------
pdf_hits <- extract_from_pdf(pdf_files, pattern)
doc_hits <- NULL
# doc_hits <- extract_from_word(doc_files, pattern)
excel_hits <- extract_from_excel(xlsx_files, pattern)
# Exact search -----------------------------------------------------------------
pdf_hits_ex <- extract_from_pdf(pdf_files, pattern_exact)
doc_hits_ex <- NULL
# doc_hits_ex <- extract_from_word(doc_files, pattern_exact)
excel_hits_ex <- extract_from_excel(xlsx_files, pattern_exact)
# Separate into exact vs. other matches ----------------------------------------
if (!is.null(nrow(pdf_hits))) {
nrow(pdf_hits) >= nrow(pdf_hits_ex)
pdf_hits_ot <- anti_join(pdf_hits, pdf_hits_ex) %>% mutate(search_type="Other")
pdf_hits_ex <- pdf_hits_ex %>% mutate(search_type="Exact")
pdf_hits <- bind_rows(pdf_hits_ot, pdf_hits_ex) %>% arrange(search_type, file_name, page_or_sheet)
# add summary info
pdf_summ <- pdf_hits %>%
group_by(keyword, file_name, search_type) %>%
summarise(
pages = paste(unique(page_or_sheet), collapse = ", "),
total_occurrences = n(),
.groups = "drop"
) %>%
select(file_name, pages, keyword, total_occurrences, search_type) %>%
arrange(file_name, search_type, pages)
# merge in categories
pdf_hits <- pdf_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
pdf_summ <- pdf_summ %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
if (!is.null(nrow(doc_hits))) {
nrow(doc_hits) >= nrow(doc_hits_ex)
doc_hits_ot <- anti_join(doc_hits, doc_hits_ex) %>% mutate(search_type="Other")
doc_hits_ex <- doc_hits_ex %>% mutate(search_type="Exact")
doc_hits <- bind_rows(doc_hits_ot, doc_hits_ex) %>% arrange(search_type, file_name)
doc_summ <- doc_hits %>%
group_by(keyword, file_name, search_type) %>%
summarise(total_occurrences = n(), .groups = "drop") %>%
select(file_name, keyword, total_occurrences, search_type) %>%
arrange(file_name, search_type)
# merge in categories
doc_hits <- doc_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
doc_summ <- doc_summ %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
if (!is.null(nrow(excel_hits))) {
nrow(excel_hits) >= nrow(excel_hits_ex)
excel_hits_ot <- anti_join(excel_hits, excel_hits_ex)  %>% mutate(search_type="Other")
excel_hits_ex <- excel_hits_ex %>% mutate(search_type="Exact")
excel_hits <- bind_rows(excel_hits_ot, excel_hits_ex) %>% arrange(search_type, file_name, page_or_sheet, row)
# merge in categories
excel_hits <- excel_hits %>%
left_join(term_list, by=c("keyword"="Terminology"))
}
# Combine all files ------------------------------------------------------------
# all_hits <- bind_rows(pdf_hits, doc_hits, excel_hits)
all_hits <- bind_rows(pdf_hits, excel_hits) #no word file results
# OUTPUT AS EXCEL ==============================================================
# Workbook formatting ----------------------------------------------------------
eo.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#000000",
border = "Bottom", borderStyle = "thick")
sc.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#AF51A8",
border = "Bottom", borderStyle = "thick")
wv.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#B43636",
border = "Bottom", borderStyle = "thick")
st.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#3C7D22",
border = "Bottom", borderStyle = "thick")
fr.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#BE5014",
border = "Bottom", borderStyle = "thick")
kw.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#4D93D9",
border = "Bottom", borderStyle = "thick")
gn.style <- createStyle(textDecoration = "Bold", halign="CENTER",
fontColour = "#ffffff", fgFill = "#002060",
border = "Bottom", borderStyle = "thick")
# For OD -----------------------------------------------------------------------
#' OD file will include results for ALL files as well as summary pages
# create output workbook
output_file <- file.path(results_path, paste0(batch_num, "_OD-results_", today_date, ".xlsx"))
wb <- createWorkbook()
addWorksheet(wb, "Matches | Snippets")
writeData(wb, "Matches | Snippets", all_hits, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | Snippets", cols = 1:ncol(all_hits), widths = "auto")
addWorksheet(wb, "Matches | PDF Summary")
writeData(wb, "Matches | PDF Summary", pdf_summ, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | PDF Summary", cols = 1:ncol(pdf_summ), widths = "auto")
if (!is.null(doc_hits)) {
addWorksheet(wb, "Matches | Doc Summary")
writeData(wb, "Matches | Doc Summary", doc_summ, headerStyle = gn.style)
setColWidths(wb, sheet = "Matches | Doc Summary", cols = 1:ncol(doc_summ), widths = "auto")
}
saveWorkbook(wb, output_file, overwrite = TRUE)
# For Reviewers ----------------------------------------------------------------
#' For reviewers, include only exact, all_hit results with a separate tab for
#' each theme, a dropdown for compliance action, and a box for comments
all_files <- all_hits$file_name %>% unique()
for (file in all_files) {
# create separate sheets for each theme
eo_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(EO)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words")) %>%
mutate(followup_action=NA, reviewer_notes=NA)
sci_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Science)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
wai_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Waiver_Bridge)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
strat_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Strategic.Content)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
frame_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Framing)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
key_hits <- all_hits %>%
filter(file_name==file & search_type=="Exact" & !is.na(Key_Words)) %>%
select(-c("EO", "Science", "Waiver_Bridge", "Strategic.Content", "Framing", "Key_Words"))  %>%
mutate(followup_action=NA, reviewer_notes=NA)
# create workbook
output_file <- file.path(results_path, paste0("Results_", file %>% str_replace_all("_Converted.pdf", ""), "_", today_date, ".xlsx"))
wb <- createWorkbook()
# add EO match sheet
addWorksheet(wb, "Matches | EO Compliance")
writeData(wb, "Matches | EO Compliance", eo_hits, headerStyle = eo.style)
setColWidths(wb, sheet = "Matches | EO Compliance", cols = 1:ncol(eo_hits), widths = "auto")
# add Science match sheet
addWorksheet(wb, "Matches | Science")
writeData(wb, "Matches | Science", sci_hits, headerStyle = sc.style)
setColWidths(wb, sheet = "Matches | Science", cols = 1:ncol(sci_hits), widths = "auto")
# add Waiver match sheet
addWorksheet(wb, "Matches | Waiver_Bridge")
writeData(wb, "Matches | Waiver_Bridge", wai_hits, headerStyle = wv.style)
setColWidths(wb, sheet = "Matches | Waiver_Bridge", cols = 1:ncol(wai_hits), widths = "auto")
# add Strategic Content match sheet
addWorksheet(wb, "Matches | Strategic Content")
writeData(wb, "Matches | Strategic Content", strat_hits, headerStyle = st.style)
setColWidths(wb, sheet = "Matches | Strategic Content", cols = 1:ncol(strat_hits), widths = "auto")
# add Framing match sheet
addWorksheet(wb, "Matches | Framing")
writeData(wb, "Matches | Framing", frame_hits, headerStyle = fr.style)
setColWidths(wb, sheet = "Matches | Framing", cols = 1:ncol(frame_hits), widths = "auto")
# add Keywords match sheet
addWorksheet(wb, "Matches | Keywords")
writeData(wb, "Matches | Keywords", key_hits, headerStyle = kw.style)
setColWidths(wb, sheet = "Matches | Keywords", cols = 1:ncol(key_hits), widths = "auto")
# set up dropdown values
action_options <- data.frame(
actions = c("Reviewed. No issue", "Reviewed. Potential issue. Further review needed."))
# add dropdown sheet
addWorksheet(wb, "DropdownValues")
writeData(wb, sheet = "DropdownValues", x = action_options, colNames = FALSE)
sheetVisibility(wb)[7] <- "hidden"
# add dropdown to the followup_action column
dataValidation(
wb,
sheet = "Matches | EO Compliance",
col = 8,
rows = 2:(nrow(eo_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Science",
col = 8,
rows = 2:(nrow(sci_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Waiver_Bridge",
col = 8,
rows = 2:(nrow(wai_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Strategic Content",
col = 8,
rows = 2:(nrow(strat_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Framing",
col = 8,
rows = 2:(nrow(frame_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
dataValidation(
wb,
sheet = "Matches | Keywords",
col = 8,
rows = 2:(nrow(frame_hits) + 1), # Apply to all data rows
type = "list",
value = "'DropdownValues'!$A$1:$A$2" # Range of dropdown values in 'DropdownValues' sheet
)
# add conditional formatting to the followup_action column
conditionalFormatting(
wb,
sheet = "Matches | EO Compliance",
cols = 8,
rows = 2:(nrow(eo_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Science",
cols = 8,
rows = 2:(nrow(sci_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Waiver_Bridge",
cols = 8,
rows = 2:(nrow(wai_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Strategic Content",
cols = 8,
rows = 2:(nrow(strat_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Framing",
cols = 8,
rows = 2:(nrow(frame_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
conditionalFormatting(
wb,
sheet = "Matches | Keywords",
cols = 8,
rows = 2:(nrow(frame_hits) + 1),
type = "contains",
rule = "Reviewed. Potential issue. Further review needed.",
style = createStyle(bgFill="#FFC7CE", fontColour="#9C0006")
)
# save!
saveWorkbook(wb, output_file, overwrite = TRUE)
}
library(openxlsx)
library(tidyverse)
library(ggtext)
library(ggrepel)
getwd() #shows current directory
setwd("C:\\Users\\kwn5\\OneDrive - CDC\\Trainings\\2026_EIS-Training")
getwd() #shows current directory
setwd("C:\\Users\\kwn5\\OneDrive - CDC\\Trainings\\2026_EIS-Training\\ggplot2-tutorials")
resp_dat <- read.csv(".\\Raw\\nssp_ed_covid19_flu_rsv.csv")
# preview data
str(resp_dat)
resp_dat <- read.csv(".\\Raw\\nssp_ed_covid19_flu_rsv.csv")
# preview data
str(resp_dat)
# filter to national data
resp_dat_usa <- resp_dat %>%
filter(geography=="United States" & county=="All")
# transform to tidy format
resp_dat_usa <- resp_dat_usa %>%
select(week_end, geography, county,
percent_visits_covid, percent_visits_influenza, percent_visits_rsv) %>%
pivot_longer(
cols = starts_with("percent_visits"),
names_to = "condition",
names_prefix = "percent_visits_",
values_to = "percent_visits"
)
# preview data
str(resp_dat)
# change week_end from chr to date
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end)
# preview data
str(resp_dat)
# preview data
str(resp_dat_usa)
# change week_end from chr to date
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end)
# change week_end from chr to date
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end, "%m/%d/%Y")
str(resp_dat_usa)
# merge in mmwr weeks
mmwr_dates <- read.csv(".\\Raw\\mmwr-weeks.csv")
mmwr_dates
# preview data
head(mmwr_data)
# preview data
head(mmwr_dates)
# transform for merge
mmwr_dates <- mmwr_dates %>%
pivot_longer(
cols = starts_with("X"),
names_to = "year",
names_prefix = "X",
values_to = "week_end"
) %>%
select(-year) %>%
arrange(week_end)
# convert week_end to date
mmwr_dates$week_end <- as.Date(mmwr_dates$week_end, "%m/%d/%Y")
mmwr_dates <- mmwr_dates %>% filter(!is.na(week_end))
# merge mmwr_dates to resp_dat_usa
resp_dat_usa <- resp_dat_usa %>% left_join(mmwr_dates)
# preview data
head(resp_dat_usa)
write.csv(resp_dat_usa, ".\\Datasets\\resp-dat-usa.csv", row.names=F)
# DESCRIPTION ------------------------------------------------------------------
#' Enter description here
# SET-UP -----------------------------------------------------------------------
# load packages
library(openxlsx)
library(tidyverse)
library(ggtext)
library(ggrepel)
# set directory
getwd() #shows current directory
setwd("C:\\Users\\kwn5\\OneDrive - CDC\\Trainings\\2026_EIS-Training\\ggplot2-tutorials")
resp_dat_usa <- read.csv(".\\Datasets\\resp_dat_usa.csv")
resp_dat_usa <- read.csv(".\\Datasets\\resp-dat-usa.csv")
# view summary
str(resp_dat_usa)
# check data types
resp_dat_usa$week_end <- as.Date(resp_dat_usa, "%Y-%mm%dd")
# check data types
resp_dat_usa$week_end <- as.Date(resp_dat_usa, "%Y-%mm-%dd")
# check data types
resp_dat_usa$week_end <- as.Date(resp_dat_usa, "%Y-%m-%d")
# check data types
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end, "%Y-%m-%d")
# view summary
str(resp_dat_usa)
# DESCRIPTION ------------------------------------------------------------------
#' This code transforms full data downloaded from the data source (URL below) to
#' a tidy national dataset for ggplot2 training.
#'
#' https://data.cdc.gov/Public-Health-Surveillance/NSSP-Emergency-Department-Visit-Trajectories-by-St/rdmq-nq56/about_data
# SET-UP -----------------------------------------------------------------------
# load packages
library(openxlsx)
library(tidyverse)
library(ggtext)
library(ggrepel)
# set directory
getwd() #shows current directory
setwd("C:\\Users\\kwn5\\OneDrive - CDC\\Trainings\\2026_EIS-Training\\ggplot2-tutorials")
# EXAMINE DATA -----------------------------------------------------------------
resp_dat <- read.csv(".\\Raw\\nssp_ed_covid19_flu_rsv.csv")
# preview data
str(resp_dat)
#' percent_visits
#' * Denominator: all ED patient visits for the specified geography that were
#'   observed for the given week.
#' * Numerator: ED patient visits for the pathogen of interest for the specified
#'   geography that were observed for the given week.
# CREATE TIDY DATASET ----------------------------------------------------------
# filter to usa
resp_dat_usa <- resp_dat %>%
filter(geography=="United States" & county=="All")
# transform to tidy format
resp_dat_usa <- resp_dat_usa %>%
select(week_end, geography, county,
percent_visits_covid, percent_visits_influenza, percent_visits_rsv) %>%
pivot_longer(
cols = starts_with("percent_visits"),
names_to = "condition",
names_prefix = "percent_visits_",
values_to = "percent_visits"
)
# preview data
str(resp_dat_usa)
# change week_end from chr to date
# specify current format as mm/dd/yyyy
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end, "%m/%d/%Y")
str(resp_dat_usa)
resp_dat_usa <- resp_dat_usa %>%
mutate(condition=case_when(
condition=="covid" ~ "COVID-19",
condition=="influenza" ~ "Influenza",
condition=="rsv" ~ "RSV")
)
resp_dat_usa
# load mmwr dates data
mmwr_dates <- read.csv(".\\Raw\\mmwr-weeks.csv")
# preview data
head(mmwr_dates)
# transform for merge
mmwr_dates <- mmwr_dates %>%
pivot_longer(
cols = starts_with("X"),
names_to = "year",
names_prefix = "X",
values_to = "week_end"
) %>%
select(-year) %>%
arrange(week_end)
# convert week_end to date
mmwr_dates$week_end <- as.Date(mmwr_dates$week_end, "%m/%d/%Y")
mmwr_dates <- mmwr_dates %>% filter(!is.na(week_end))
# merge mmwr_dates to resp_dat_usa
resp_dat_usa <- resp_dat_usa %>% left_join(mmwr_dates)
# preview data
head(resp_dat_usa)
# SAVE DATASET FOR TRAINING ----------------------------------------------------
write.csv(resp_dat_usa, ".\\Datasets\\resp-dat-usa.csv", row.names=F)
# DESCRIPTION ------------------------------------------------------------------
#' Enter description here
# SET-UP -----------------------------------------------------------------------
# load packages
library(openxlsx)
library(tidyverse)
library(ggtext)
library(ggrepel)
# set directory
getwd() #shows current directory
setwd("C:\\Users\\kwn5\\OneDrive - CDC\\Trainings\\2026_EIS-Training\\ggplot2-tutorials")
# READ IN DATA -----------------------------------------------------------------
resp_dat_usa <- read.csv(".\\Datasets\\resp-dat-usa.csv")
# view summary
str(resp_dat_usa)
# check data types
resp_dat_usa$week_end <- as.Date(resp_dat_usa$week_end, "%Y-%m-%d")
resp_dat_usa
ggplot(data=resp_dat_usa,
aes(x=week_end, y=percent_visits, group=condition)) +
geom_line(aes(colour=condition), linewidth=1.5) +
scale_color_manual(values=c(covid="#F06F19", influenza="#0A58D6",rsv="#890664")) +
scale_y_continuous(name=NULL, limits=c(0,9), breaks=c(0:9), expand=c(0,0)) +
scale_x_date(name="Week end", date_breaks = "6 months", date_labels="%b\n%Y",
expand=c(0,0)) +
guides(colour = guide_legend(title="")) +
annotate("text", x=min(resp_dat_usa$week_end), y=9, label="% of visit",
hjust=0, vjust=0.5,
size = (11*0.8)/.pt,
color = "grey30") +
ggtitle("Emergency department visits in the <b>United States</b>") +
coord_cartesian(clip="off") + #allows drawing outside of plot area
theme_minimal() +
theme(
plot.title=element_markdown(),
legend.title=element_text(face="bold"), legend.position="top",
axis.title.x=element_text(margin=margin(t=10)))
base <- ggplot(data=resp_dat_usa,
aes(x=week_end, y=percent_visits, group = condition))
base
base + geom_line()
base + geom_line(aes(colour=condition))
base +
geom_line(aes(colour=condition)) +
scale_color_manual(values=c("COVID-19"="#C04F15", "Influenza"="#0A58D6","RSV"="#652B5A"))
base + geom_line(linewidth=1.5)
base + geom_line(aes(colour=condition), linewidth=1.5)
base +
geom_line(aes(colour=condition), linewidth=1.5) +
scale_color_manual(values=c("COVID-19"="#C04F15", "Influenza"="#0A58D6","RSV"="#652B5A"))
base +
geom_line(aes(colour=condition), linewidth=1.5) +
scale_color_manual(values=c("COVID-19"="#C04F15", "Influenza"="#0A58D6","RSV"="#652B5A")) +
# y-axis is continuous
# limit: min of 0, max of 9
# breaks: tick marks every 1 unit
scale_y_continuous(limits=c(0,9), breaks=c(0:9), expand=c(0,0)) +
# x-axis is date
# date_breaks: tick marks every 6 months
# date_labels: format as "Jan. YYYY"
scale_x_date(date_breaks = "6 months", date_labels="%b %Y", expand=c(0,0))
